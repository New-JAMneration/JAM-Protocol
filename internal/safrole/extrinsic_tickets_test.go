package safrole

import (
	"encoding/hex"
	"reflect"
	"testing"

	"github.com/New-JAMneration/JAM-Protocol/internal/store"
	"github.com/New-JAMneration/JAM-Protocol/internal/types"
	SaforleErrorCode "github.com/New-JAMneration/JAM-Protocol/internal/types/error_codes/safrole"
)

// publish-tickets-no-mark-1.json
// Submit an extrinsic with a bad ticket attempt number.
func TestCheckTicketsAttempt(t *testing.T) {
	ticketAttemptErr := SaforleErrorCode.BadTicketAttempt
	testCases := []struct {
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-1.json
		// Submit an extrinsic with a bad ticket attempt number.
		{
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x38eff9f9cac7ca015bafd5c84e84ed75ee86b6ecc98902044a7a7aa28d60f0e547f9c1bf782f01bc5fe47d19858abe928ad3eed82e0f77680e91ed8a1603c6a11028f8df1478991aa1a24cb243603d3f434a3d563d7ec08931c6f2bfa38f9ebf99527196430c2f6bc38cc775336bffb82ecea3e8040f80a846b638a4a1a7388d629bbd5c127a56b0a1b5d6b1d7fefcef0c39218c084a6921141376ed64f72b0869c6301b8fd3a0721774ae1353cbb31228f04f5491aa72387550d12f813d15188f55a0c9095bc21a9a084bf10b434b2fbfc2f1879f2235342bcc03ce4dbe0c2902c6c5dfa4b309da00a8b72eb3be15d28d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f819e2ee13f4951a970075b928f4f53614c2038cb899083c5b0ffe5fbe5685a8ce738129c83791d0331b7bdf75dbde863addc1440fc771664e6ced8803cbb074c377c8203e453035d4061a7ccf651f7aa70782322cf5a9ade316f62b2c109f22156b466c349402da1333b8c144aa503c1aaedd49097055e780fc849b3ba68365a710e12206af8802ead9536aab3535be932bd78360283c6aa70a457146921021b05656dc7ca225f390fb80740a08ff15c340dfddbd4521088b0d2c253a6fa9014529489123c923fed4d2d0dbe9035192d51a1248dba1420cd6149d71215add23092d1eb598dbd38be337d6f11255a9905d60113a0a8cff319834396f46dcb802b84c64915bf2a5f65546188d8b17824a9f7ef77ec2aa173112135dc6c4b0ae81b238470f7b19c8e47e9e34d4003b257735936b257984e182bc6e4af1240e5505f927c65e506314c345cac1e5001af7e41436fb1836ec06c0cd1c8bb90041aadbd265a074f58f047e371e31625ed919eb78e0dc40f7970b17ee399c66cb9b3c58dce8cb9e3488c1571d3489bba82262d15947524a1e3aadb625067ccbdb8f63e5b52dbe5e579e37a13b39df9655e0b2045de14ece78958e4843b912ef3debd8462ab6b13c10588bde65f9af8ceaf575b45797fe80dae6d7e79b1ed37c891b709be039ea1e12761b85475abd453b032e720")),
				},
				{
					Attempt:   3,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xfe088f1bb3f1d2bd9412f40675eb3f916feb60d772649447a8efa0b83e205c691f1369ac6785852d5469fd673a111a6d4f8d28c2b23f57b7c6040b050f0ac2b7bece0cf45d498dea58451a0c53625fccb4d55408f02f38a338b4eea5664572dec26081caa9f2643d3e10be045cb44e2f0d0505d50c580e58a651376eb32e89d2a5ca12ecc722b330cbfc039c3c97d202b9b1ef853f3095c02cb697148d33ef18245b842880ae824623450d8179affe49ead9992bb259ac1e9cbb846e41035d1890d3440407102824f9e4d56b10263ab9deb327506cd2daef0f928b41067d0119f643224d352939ba7e37891c71a231ac8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fb46ac862727e5d2255aa1c6682b57a9e47d15e1b3eab721e05d16822cf0c234623eac35a8e1f092419a10320e5115c77a6ae5e2a2affa64f3fe2768a02e3738c73589193d1bf7d60d13aae555e265e62923a460a0f5c354252acf32024763f798ffa2f16b84c9a83a1f6d753c9aeda0a4d501c1c3280075c307a1bf92a5cfd0d076cf20d04930d9fe2527f94643736034da5a76eee730c6c637f0533f69fd872e8f27c4d192a563b493fd557b99a131eaf4e032780389786b5967df8c380681185040a25fd4501a34778fd770c36ae17c8350a4f6ec2f0aa9a787f7e7ea94311455ab012b6b80327fe08777233dd2bc5f14f74ac364d12e1e5ed9164f1dec952fbea646c0d122962eea7c266babcd568e4d72796f414176fddc70bd12ce6ad301f42727cf1433dfcfedd6e37f23262cd4ecb5652fe52f2eaf712ff07f63b7a5e8b8374d2791b16a0086fbb21b8eff72d78cf1b399c3cceed5da34274b17856916c6162af17cb6b7d696573f9359bce26972ff6251437685da89996cd1060aebc83ad096b6f5afbb0313c7bffe3b3a315afde15db3afa0791622e6d8d5f3039393bfb31333a2c8ebb926e4b7c4612a943bb002ddaffbc29593ad650568642ca46ae35205f576315b6d49ae87179176549527c788d587f54c0d0dc216a3e4747a7230a55de871fa9c5ea489caebb157ec7")),
				},
			},
			expectedErr: &ticketAttemptErr,
		},
	}

	for _, tc := range testCases {
		err := VerifyTicketsAttempt(tc.tickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// publish-tickets-no-mark-3.json
// Submit one ticket already recorded in the state.
func TestVerifyTicketsDuplicate(t *testing.T) {
	duplicateTicketErr := SaforleErrorCode.DuplicateTicket
	testCases := []struct {
		slot        types.TimeSlot
		pks         []types.BandersnatchPublic
		entropy     types.Entropy
		tickets     types.TicketsExtrinsic
		gammaA      types.TicketsAccumulator
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			slot: types.TimeSlot(1),
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			gammaA:      types.TicketsAccumulator{},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-3.json
		// Submit one ticket already recorded in the state.
		{
			slot: types.TimeSlot(2),
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x1dfb7b61deee0c4a6899c1123e9e362f2b965079be576aebda0b7ac5e111186e45649b3aa58e18cb4faa3cc74688a322fcd5ab4d591dc2e183f4e31f3f5b926fefcb067f0b43fc9bda32af4bdcbf8767945d01e9816327857a3537929a304eea39fa798e7a8327dcba940ffa77659b1850f877be7a439fc3a66191299d5ae9240e005d84cfbd9fe9a1b250873d484fdf90a03e6b3238a3143f3692ef3128cf1961c8246ca93c957ea7907f7d1dd80e745ecada3f48dbdcbf14dca402df264303a445e67a96d618c4fc1c100a69fa449cca1db6a7ac609d7bd04107f685411aa1bebecdb3897ed0d6c00b46a56381e5968b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dad8952d2acaa7ebb6da732dd2e34cc2211a953d575e70137e69ce03526f0677ffc2c77f3488b19a3383188e0beaa03fd32b97e7a991fadd8d9d2c71a2d37c836adba04e6f9b5a9f58ecdfb3aaaada4161e283ecb8c295efdf53635ba73ca20f47181e9d7529da701fb654d55d99ff7a9af4c5b678f7ba7d764c48ea2b15569ee1d20a10029a50d5b1100356b64916c6c38526d1dac1f169e5f4250f27dd9cb7454af6591aac3e7353b3a083f310d735eb7a7530fcddc3d06fad7efbca9bf7e3e22306fa2dfd6a184cf5d0acc29ef7cc35c07a7c1e2fc75bb42c80834f000c5d85b293f40ed6b605ec94df44d87712eec2ad1d1386564e5fd2491ec42317aea9058a44e850b08e2a2c4d261c7c59a96be65d89555285c24326c052b5d102cb8a8341b97fcdb28bf8ad1a5591613dc119f7bc44abba455075baf954149a05ae35f13a1e585445577cd9f13c20a04194307716df5f290403147dc728cff8324ee06b0724bbd11fb59a4f3d717a15726c41113e1fd7adcacb5e303a974dd1f6b74028bd1c61f204a43a8ec0bdcf161ff8f2310ac411ceb866d641d29ca3e68fa259f6ee960d3d5835f930f788a3021c5467b619dbc9e5b8b80a6bdac820d1f56fa282fac56c299a7b2cd1d7b2d9b81e6c28bf2a7d6da6b40a02f4ba2aee0f37311c16b941aeaa11e6e40b16f91cad2089ccfc3")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x3f34a69e20ecb3a92106aaf5765a4d2f2925681b70965aa97ecd149e4dcca4c396b24f2969786544b8bc42b2f5c336c0b61fa38333c99414bc59b18c59d932c6b15e442e616d2967a22bd9a3397ee12621b1da977b95aa46c790eaa07ae23b1dbc9f783ae081d7757ef01daa2a24408c1262de6a12c321ec28373be4065f63ad65129cef62e7ab15ab49d89e507d6241c8f29a28fee463039e62ec7822e4d01537fee8357d3150b1184e777506b4baf634fd2e7d3c56a4cc35d422816a5ef910b6414e8b37639b6dc29939ddaddae87c7ccabb0b75619fc305ddcb15e4ca72c73013a4747deb10967489e1099b1528268b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadb848cccce62965ee2913c61fa41d0c5d26325b0d2e89fd6339a386bd1fc53664f2856c080fd1a3145f920c765616630d8bb964fe4d3cf1653f1e1190400181a76ff9f9476d6ae4052410c981bc8c81b5399d2c692b51e8278808751494a116ba9170ffe2c2c2506d06b890dd47cd00209933562c035a310647059f774c0a64571b7bee8319de78d63e7fe5e1775ce77916de84c6ab8b383cb036c1b7e3ac6b12f47f87c3c016ab16f20a43a94d1f1ea3c3fa3e2029058a58e852959e2c44e25ef79865f4a3fa4d4872d79324272202aa306f233fc235d364a0dc9009b21e49295f78e38a820279050ae921df1c039eb70ee202e2b56445d158c76fbb4d70a70830f3a13e605816ad032d5532d56ea552d6b30381ccfd1ebdcb5a80472c86170640b4e6cbaccc36f194c8183fb061b539bca57425350f63374e72d6058190b571945593877f3a6e89e25501749b658bca067f220c7d68b4e4a4b6b0b113d6e734bccab561190509484a71f3157e482edbf99693852303c5a3106e0105292e94470c9a819ecd6e6266c304bcdf5fc9743da87955290d5ddfdf9c708658e236a817774fa302c8a328f308be03a36491f609c7e5e13a0a18b3ea16714ccf0479352394350a6637ac47d06c213a0dc7b44734b57235d1eadda857b1ee2504c67a12f69c034c72498dd2e14e6f06679ef2109c")),
				},
			},
			gammaA: types.TicketsAccumulator{
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x09a696b142112c0af1cd2b5f91726f2c050112078e3ef733198c5f43daa20d2b")),
				},
				{
					Attempt: 2,
					Id:      types.TicketId(hexToBytes("0x13fecb426e0a73b84b58b9a0832b11582dc971e79c5399e69f0baf1a244c7787")),
				},
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x3a5d10abc80dda33fe3f40b3bb2e3eefd3e97dda3d617a860c9d94eb70b832ad")),
				},
			},
			expectedErr: &duplicateTicketErr,
		},
	}

	for _, tc := range testCases {
		s := store.GetInstance()

		gamma_k := types.ValidatorsData{}
		for _, pk := range tc.pks {
			gamma_k = append(gamma_k, types.Validator{Bandersnatch: pk})
		}

		eta := types.EntropyBuffer{}
		eta[2] = tc.entropy

		s.GetPosteriorStates().SetGammaK(gamma_k)
		s.GetPosteriorStates().SetEta(eta)
		s.GetPosteriorStates().SetTau(tc.slot)
		s.GetPriorStates().SetGammaA(tc.gammaA)

		err := CreateNewTicketAccumulator(tc.tickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// publish-tickets-no-mark-4.json
// Submit tickets in bad order.
func TestVerifyTicketsOrder(t *testing.T) {
	ticketOrderErr := SaforleErrorCode.BadTicketOrder
	testCases := []struct {
		pks         []types.BandersnatchPublic
		entropy     types.Entropy
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-4.json
		// Submit tickets in bad order.
		{
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x085d8b17dd23a3d2e6b785f5a3ca389c5c6b6b0958fa6aa24daed4dcb0d0ac218ca53d13adcb507df05116e054c5bab3969c377f4c27145cb877eca54af4a7a44454c09d327fd0a87c9c100d6d2807566c19d0b9f4b5c620ea3f184c04f129db0d3862d12ac56a68961882ef6acade3960470814fd165d1d99ffd0312a114f382f7dc2b9698a741c2d385738b9710acb83bbf397c8725f03e0e4ed823b10d90a8b9b1bd5592120c58f6f607ec735510dddf689b75f0757a36243875ae89d8500a3615ab86d8b9294c1f39754f1e13307e4871dd4711c89b88ce19e4f641344faa00a8c02d5caabebd4a0491ce7ff99e38b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadaca589a2245daa460c8b1d2692e3b8dd2b16b33d435ea751f62a57454472218e0a5038326422481f02a2113d9f8ac15691f1f2872315a81a64c84a6876ea55b3ce693622fa8c9ba8f69fc5efc27e83f11c5d43f6e72c1c9587c1a2dd1e1306194655872e7c923adb6b087ee020275deccf047dc74d45929461b28d4768b89445469de53ee0e493700b981d62115bbb9439d9070e4a0fe2faa37f3b96fee5ec6fa8e7004fbed855ed5d5f89f195a3c8facb03d00f53eed56acd853cd824d18b33347a2dff9fe2ceccbda9f89da0453a16fa9febd9c0e41c4419258d3ee7860b58398398f28dcf558de5c8b9ded668f694747764bf42b028d45b2de49aa23818273e7312abc3dd24f5281315cb5662bf479ae50b4a61c100fdcf796f0c1aa06854706ed7f123dc669e2f6fe1d15c2b35889e9e93894fc20d8168c80d6eded2ce0092f3ceb63faedb3ac2fb3d9105f4fa39e9ba3b0fd8e212d970b648c608d7fbb85aeca7f64be454b20db0eebb41271eba6f6250796e1a373f2728c37a690a5869219dc312969a1dd9a643e7186f7e964eb814bd528eb1480303bccd3489bf616d336de95722b7f5f8fd0eac5f01d064bf8ffdc5d88127dd46f23d65016545ed2ea21e5efd32151c5fb4779851c0e50445b85a9ca74d1b249bb0a6ab3c3b7c7f73eceb262ed642fa9750c2819cb9c58a49")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x3f34a69e20ecb3a92106aaf5765a4d2f2925681b70965aa97ecd149e4dcca4c396b24f2969786544b8bc42b2f5c336c0b61fa38333c99414bc59b18c59d932c6b15e442e616d2967a22bd9a3397ee12621b1da977b95aa46c790eaa07ae23b1dbc9f783ae081d7757ef01daa2a24408c1262de6a12c321ec28373be4065f63ad65129cef62e7ab15ab49d89e507d6241c8f29a28fee463039e62ec7822e4d01537fee8357d3150b1184e777506b4baf634fd2e7d3c56a4cc35d422816a5ef910b6414e8b37639b6dc29939ddaddae87c7ccabb0b75619fc305ddcb15e4ca72c73013a4747deb10967489e1099b1528268b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadb848cccce62965ee2913c61fa41d0c5d26325b0d2e89fd6339a386bd1fc53664f2856c080fd1a3145f920c765616630d8bb964fe4d3cf1653f1e1190400181a76ff9f9476d6ae4052410c981bc8c81b5399d2c692b51e8278808751494a116ba9170ffe2c2c2506d06b890dd47cd00209933562c035a310647059f774c0a64571b7bee8319de78d63e7fe5e1775ce77916de84c6ab8b383cb036c1b7e3ac6b12f47f87c3c016ab16f20a43a94d1f1ea3c3fa3e2029058a58e852959e2c44e25ef79865f4a3fa4d4872d79324272202aa306f233fc235d364a0dc9009b21e49295f78e38a820279050ae921df1c039eb70ee202e2b56445d158c76fbb4d70a70830f3a13e605816ad032d5532d56ea552d6b30381ccfd1ebdcb5a80472c86170640b4e6cbaccc36f194c8183fb061b539bca57425350f63374e72d6058190b571945593877f3a6e89e25501749b658bca067f220c7d68b4e4a4b6b0b113d6e734bccab561190509484a71f3157e482edbf99693852303c5a3106e0105292e94470c9a819ecd6e6266c304bcdf5fc9743da87955290d5ddfdf9c708658e236a817774fa302c8a328f308be03a36491f609c7e5e13a0a18b3ea16714ccf0479352394350a6637ac47d06c213a0dc7b44734b57235d1eadda857b1ee2504c67a12f69c034c72498dd2e14e6f06679ef2109c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x1dfb7b61deee0c4a6899c1123e9e362f2b965079be576aebda0b7ac5e111186e45649b3aa58e18cb4faa3cc74688a322fcd5ab4d591dc2e183f4e31f3f5b926fefcb067f0b43fc9bda32af4bdcbf8767945d01e9816327857a3537929a304eea39fa798e7a8327dcba940ffa77659b1850f877be7a439fc3a66191299d5ae9240e005d84cfbd9fe9a1b250873d484fdf90a03e6b3238a3143f3692ef3128cf1961c8246ca93c957ea7907f7d1dd80e745ecada3f48dbdcbf14dca402df264303a445e67a96d618c4fc1c100a69fa449cca1db6a7ac609d7bd04107f685411aa1bebecdb3897ed0d6c00b46a56381e5968b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dad8952d2acaa7ebb6da732dd2e34cc2211a953d575e70137e69ce03526f0677ffc2c77f3488b19a3383188e0beaa03fd32b97e7a991fadd8d9d2c71a2d37c836adba04e6f9b5a9f58ecdfb3aaaada4161e283ecb8c295efdf53635ba73ca20f47181e9d7529da701fb654d55d99ff7a9af4c5b678f7ba7d764c48ea2b15569ee1d20a10029a50d5b1100356b64916c6c38526d1dac1f169e5f4250f27dd9cb7454af6591aac3e7353b3a083f310d735eb7a7530fcddc3d06fad7efbca9bf7e3e22306fa2dfd6a184cf5d0acc29ef7cc35c07a7c1e2fc75bb42c80834f000c5d85b293f40ed6b605ec94df44d87712eec2ad1d1386564e5fd2491ec42317aea9058a44e850b08e2a2c4d261c7c59a96be65d89555285c24326c052b5d102cb8a8341b97fcdb28bf8ad1a5591613dc119f7bc44abba455075baf954149a05ae35f13a1e585445577cd9f13c20a04194307716df5f290403147dc728cff8324ee06b0724bbd11fb59a4f3d717a15726c41113e1fd7adcacb5e303a974dd1f6b74028bd1c61f204a43a8ec0bdcf161ff8f2310ac411ceb866d641d29ca3e68fa259f6ee960d3d5835f930f788a3021c5467b619dbc9e5b8b80a6bdac820d1f56fa282fac56c299a7b2cd1d7b2d9b81e6c28bf2a7d6da6b40a02f4ba2aee0f37311c16b941aeaa11e6e40b16f91cad2089ccfc3")),
				},
			},
			expectedErr: &ticketOrderErr,
		},
	}

	for _, tc := range testCases {
		s := store.GetInstance()

		gamma_k := types.ValidatorsData{}
		for _, pk := range tc.pks {
			gamma_k = append(gamma_k, types.Validator{Bandersnatch: pk})
		}

		eta := types.EntropyBuffer{}
		eta[2] = tc.entropy

		s.GetPosteriorStates().SetGammaK(gamma_k)
		s.GetPosteriorStates().SetEta(eta)

		newTickets, _ := VerifyTicketsProof(tc.tickets)
		err := VerifyTicketsOrder(newTickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// publish-tickets-no-mark-5.json
// Submit tickets with bad ring proof.
func TestVerifyTicketsProof(t *testing.T) {
	badTicketProofErr := SaforleErrorCode.BadTicketProof
	testCases := []struct {
		pks         []types.BandersnatchPublic // from gamma_k
		entropy     types.Entropy
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-5.json
		// Submit tickets with bad ring proof.
		{
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x1dfb7b61deee0c4a6899c1123e9e362f2b965079be576aebda0b7ac5e111186e45649b3aa58e18cb4faa3cc74688a322fcd5ab4d591dc2e183f4e31f3f5b926fefcb067f0b43fc9bda32af4bdcbf8767945d01e9816327857a3537929a304eea39fa798e7a8327dcba940ffa77659b1850f877be7a439fc3a66191299d5ae9240e005d84cfbd9fe9a1b250873d484fdf90a03e6b3238a3143f3692ef3128cf1961c8246ca93c957ea7907f7d1dd80e745ecada3f48dbdcbf14dca402df264303a445e67a96d618c4fc1c100a69fa449cca1db6a7ac609d7bd04107f685411aa1bebecdb3897ed0d6c00b46a56381e5968b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dad8952d2acaa7ebb6da732dd2e34cc2211a953d575e70137e69ce03526f0677ffc2c77f3488b19a3383188e0beaa03fd32b97e7a991fadd8d9d2c71a2d37c836adba04e6f9b5a9f58ecdfb3aaaada4161e283ecb8c295efdf53635ba73ca20f47181e9d7529da701fb654d55d99ff7a9af4c5b678f7ba7d764c48ea2b15569ee1d20a10029a50d5b1100356b64916c6c38526d1dac1f169e5f4250f27dd9cb7454af6591aac3e7353b3a083f310d735eb7a7530fcddc3d06fad7efbca9bf7e3e22306fa2dfd6a184cf5d0acc29ef7cc35c07a7c1e2fc75bb42c80834f000c5d85b293f40ed6b605ec94df44d87712eec2ad1d1386564e5fd2491ec42317aea9058a44e850b08e2a2c4d261c7c59a96be65d89555285c24326c052b5d102cb8a8341b97fcdb28bf8ad1a5591613dc119f7bc44abba455075baf954149a05ae35f13a1e585445577cd9f13c20a04194307716df5f290403147dc728cff8324ee06b0724bbd11fb59a4f3d717a15726c41113e1fd7adcacb5e303a974dd1f6b74028bd1c61f204a43a8ec0bdcf161ff8f2310ac411ceb866d641d29ca3e68fa259f6ee960d3d5835f930f788a3021c5467b619dbc9e5b8b80a6bdac820d1f56fa282fac56c299a7b2cd1d7b2d9b81e6c28bf2a7d6da6b40a02f4ba2aee0f37311c16b941aeaa11e6e40b16f91cad2089ccfc3")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x3f34a69e20ecb3a92106aaf5765a4d2f2925681b70965aa97ecd149e4dcca4c396b24f2969786544b8bc42b2f5c336c0b61fa38333c99414bc59b18c59d932c6b15e442e616d2967a22bd9a3397ee12621b1da977b95aa46c790eaa07ae23b1dbc9f783ae081d7757ef01daa2a24408c1262de6a12c321ec28373be4065f63ad65129cef62e7ab15ab49d89e507d6241c8f29a28fee463039e62ec7822e4d01537fee8357d3150b1184e777506b4baf634fd2e7d3c56a4cc35d422816a5ef910b6414e8b37639b6dc29939ddaddae87c7ccabb0b75619fc305ddcb15e4ca72c73013a4747deb10967489e1099b1528268b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadb848cccce62965ee2913c61fa41d0c5d26325b0d2e89fd6339a386bd1fc53664f2856c080fd1a3145f920c765616630d8bb964fe4d3cf1653f1e1190400181a76ff9f9476d6ae4052410c981bc8c81b5399d2c692b51e8278808751494a116ba9170ffe2c2c2506d06b890dd47cd00209933562c035a310647059f774c0a64571b7bee8319de78d63e7fe5e1775ce77916de84c6ab8b383cb036c1b7e3ac6b12f47f87c3c016ab16f20a43a94d1f1ea3c3fa3e2029058a58e852959e2c44e25ef79865f4a3fa4d4872d79324272202aa306f233fc235d364a0dc9009b21e49295f78e38a820279050ae921df1c039eb70ee202e2b56445d158c76fbb4d70a70830f3a13e605816ad032d5532d56ea552d6b30381ccfd1ebdcb5a80472c86170640b4e6cbaccc36f194c8183fb061b539bca57425350f63374e72d6058190b571945593877f3a6e89e25501749b658bca067f220c7d68b4e4a4b6b0b113d6e734bccab561190509484a71f3157e482edbf99693852303c5a3106e0105292e94470c9a819ecd6e6266c304bcdf5fc9743da87955290d5ddfdf9c708658e236a817774fa302c8a328f308be03a36491f609c7e5e13a0a18b3ea16714ccf0479352394350a6637ac47d06c213a0dc7b44734b57235d1eadda857b1ee2504c67a12f69c034c72498dd2e14e6f06679ef2109c")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x085d8b17dd23a3d2e6b785f5a3ca389c5c6b6b0958fa6aa24daed4dcb0d0ac218ca53d13adcb507df05116e054c5bab3969c377f4c27145cb877eca54af4a7a44454c09d327fd0a87c9c100d6d2807566c19d0b9f4b5c620ea3f184c04f129db0d3862d12ac56a68961882ef6acade3960470814fd165d1d99ffd0312a114f382f7dc2b9698a741c2d385738b9710acb83bbf397c8725f03e0e4ed823b10d90a8b9b1bd5592120c58f6f607ec735510dddf689b75f0757a36243875ae89d8500a3615ab86d8b9294c1f39754f1e13307e4871dd4711c89b88ce19e4f641344faa00a8c02d5caabebd4a0491ce7ff99e38b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadaca589a2245daa460c8b1d2692e3b8dd2b16b33d435ea751f62a57454472218e0a5038326422481f02a2113d9f8ac15691f1f2872315a81a64c84a6876ea55b3ce693622fa8c9ba8f69fc5efc27e83f11c5d43f6e72c1c9587c1a2dd1e1306194655872e7c923adb6b087ee020275deccf047dc74d45929461b28d4768b89445469de53ee0e493700b981d62115bbb9439d9070e4a0fe2faa37f3b96fee5ec6fa8e7004fbed855ed5d5f89f195a3c8facb03d00f53eed56acd853cd824d18b33347a2dff9fe2ceccbda9f89da0453a16fa9febd9c0e41c4419258d3ee7860b58398398f28dcf558de5c8b9ded668f694747764bf42b028d45b2de49aa23818273e7312abc3dd24f5281315cb5662bf479ae50b4a61c100fdcf796f0c1aa06854706ed7f123dc669e2f6fe1d15c2b35889e9e93894fc20d8168c80d6eded2ce0092f3ceb63faedb3ac2fb3d9105f4fa39e9ba3b0fd8e212d970b648c608d7fbb85aeca7f64be454b20db0eebb41271eba6f6250796e1a373f2728c37a690a5869219dc312969a1dd9a643e7186f7e964eb814bd528eb1480303bccd3489bf616d336de95722b7f5f8fd0eac5f01d064bf8ffdc5d88127dd46f23d65016545ed2ea21e5efd32151c5fb4779851c0e50445b85a9ca74d1b249bb0a6ab3c3b7c7f73eceb262ed642fa9750c2819cb9c58a49")),
				},
			},
			expectedErr: &badTicketProofErr,
		},
	}

	for _, tc := range testCases {
		s := store.GetInstance()

		// (6.29)
		// We have to use gamma_k (posterior queued validators) to generate gamma_z
		// for the Ring VRF signature
		gamma_k := types.ValidatorsData{}
		for _, pk := range tc.pks {
			gamma_k = append(gamma_k, types.Validator{Bandersnatch: pk})
		}

		// (6.29)
		// Extrinsic ticket uses posterior eta[2] as context for the Ring VRF signature
		eta := types.EntropyBuffer{}
		eta[2] = tc.entropy

		s.GetPosteriorStates().SetGammaK(gamma_k)
		s.GetPosteriorStates().SetEta(eta)

		_, err := VerifyTicketsProof(tc.tickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// publish-tickets-no-mark-7.json
// Submit tickets when epoch's lottery is over.
func TestVerifyEpochTail(t *testing.T) {
	unexpectedTicketErr := SaforleErrorCode.UnexpectedTicket
	testCases := []struct {
		slot        types.TimeSlot
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		{
			slot:        types.TimeSlot(0),
			tickets:     types.TicketsExtrinsic{},
			expectedErr: nil,
		},
		{
			slot: types.TimeSlot(types.SlotSubmissionEnd - 1),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature{1},
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature{2},
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature{3},
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-7.json
		// Submit tickets when epoch's lottery is over.
		{
			slot: types.TimeSlot(types.SlotSubmissionEnd),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x252f6071a3191c2381f6c332334372b8065d79183a02e6e95ff240ea006453ca36ba99dfb55f50e7955be524b562b0a8413f7abe2b5b9b3a44d0d1123e3036b38290876da04260d1bf2d9c0077b843b8f9ce7c4cebe0cf431f15266b56dfcff3a5ad6ed6245148298eadc4ad4776cc2f3467324c7560884ceb211aecdbdf6bea318a14a119ee1eebe8afb3534925658b45fe3f8aa1407ff0206603046565990f8c859c42ecfc88fbaeadac2ae76eae37b6f47b65dfa616dc68dbf140df31010ab7637ba2b5ef5cda3b6b081fe13b8f07de3d6d44a1d93573c33f646467f63b0f5e30e542ebd1e8981f15a4abdb7b3caf9107bd20fe94a01157764aab5f300d7e2fcba2178cb80851890a656d89550d0bebf60cca8c23575011d2f37cdc06dcdd81812aca59cefbcd6608027bf31cfbd977198ca41a994cf923293a77e7053bb29d533fce58a043bdd23fc8b3be69ff368e448b79dbd7e03490e5badeca805d83792b958fec27fe34eea99864a92c6bce9ff66c68acdca02b9d6d82c9476e4dcd6ca1c61ab04dce7b819fede57dbec2e3073bd4c3b4da72cde4d6c09ab449503ae505561b412783d3418d51ce5be337309e33969949cb226230741cc8288a665db5514a7260c93e102cb63999fc413f5bd4edc8ea2331f683afbd04c9484f590b6cc01be784c8924f91157231fd684c79913ba34a1f1ce1467b22ebb9886ac66399b857ea2ad147fa056250904963055fc70f5d35712b8ac18b28b016512def21a1ef1aa4f4166087f1adb60fd7ee52985ddda044ee0641b8ddb47ce0fde5270f573899853d6279c2acc0f4fd8fffb14ff2ad82e3a83e913f8fcce1569ce36d3f8817e82170063612021b0f46ccf2ae8d3c75e7bfbbfd145adae5dcb448fcd7e14687850c7f7622e9265f86cf4b036cf5d945df30c6ddd62b6d4288f3d1ccd7b85e75ff89a3be7973fb22647d19f30e478e8d11b0ab7e357e5fb3d16b0e2065bf5c5d506e30afc386c3ed18c6189ed7cd530a97cf1550208a17ba774869d58f18af78103a4bd9eb6629164f77eb13fa08cc1cdf96bf963f663e378ccf97bae57538fde7da504a9c39c2530aab552f441c")),
				},
			},
			expectedErr: &unexpectedTicketErr,
		},
	}

	for _, tc := range testCases {
		// Set posterior state tau
		s := store.GetInstance()
		s.GetPosteriorStates().SetTau(tc.slot)

		err := VerifyEpochTail(tc.tickets)
		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// Test create new tickets accumulator
func TestCreatCreateNewTicketAccumulator(t *testing.T) {
	testCases := []struct {
		slot        types.TimeSlot
		pks         []types.BandersnatchPublic
		entropy     types.Entropy
		tickets     types.TicketsExtrinsic
		preGammaA   types.TicketsAccumulator
		postGammaA  types.TicketsAccumulator
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			slot: types.TimeSlot(1),
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			preGammaA: types.TicketsAccumulator{},
			postGammaA: types.TicketsAccumulator{
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x09a696b142112c0af1cd2b5f91726f2c050112078e3ef733198c5f43daa20d2b")),
				},
				{
					Attempt: 2,
					Id:      types.TicketId(hexToBytes("0x13fecb426e0a73b84b58b9a0832b11582dc971e79c5399e69f0baf1a244c7787")),
				},
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x3a5d10abc80dda33fe3f40b3bb2e3eefd3e97dda3d617a860c9d94eb70b832ad")),
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-6.json
		// Submit some tickets.
		{
			slot: types.TimeSlot(2),
			pks: []types.BandersnatchPublic{
				types.BandersnatchPublic(hexToBytes("0x5e465beb01dbafe160ce8216047f2155dd0569f058afd52dcea601025a8d161d")),
				types.BandersnatchPublic(hexToBytes("0x3d5e5a51aab2b048f8686ecd79712a80e3265a114cc73f14bdb2a59233fb66d0")),
				types.BandersnatchPublic(hexToBytes("0xaa2b95f7572875b0d0f186552ae745ba8222fc0b5bd456554bfe51c68938f8bc")),
				types.BandersnatchPublic(hexToBytes("0x7f6190116d118d643a98878e294ccf62b509e214299931aad8ff9764181a4e33")),
				types.BandersnatchPublic(hexToBytes("0x48e5fcdce10e0b64ec4eebd0d9211c7bac2f27ce54bca6f7776ff6fee86ab3e3")),
				types.BandersnatchPublic(hexToBytes("0xf16e5352840afb47e206b5c89f560f2611835855cf2e6ebad1acc9520a72591d")),
			},
			entropy: types.Entropy(hexToBytes("0xbb30a42c1e62f0afda5f0a4e8a562f7a13a24cea00ee81917b86b89e801314aa")),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x1dfb7b61deee0c4a6899c1123e9e362f2b965079be576aebda0b7ac5e111186e45649b3aa58e18cb4faa3cc74688a322fcd5ab4d591dc2e183f4e31f3f5b926fefcb067f0b43fc9bda32af4bdcbf8767945d01e9816327857a3537929a304eea39fa798e7a8327dcba940ffa77659b1850f877be7a439fc3a66191299d5ae9240e005d84cfbd9fe9a1b250873d484fdf90a03e6b3238a3143f3692ef3128cf1961c8246ca93c957ea7907f7d1dd80e745ecada3f48dbdcbf14dca402df264303a445e67a96d618c4fc1c100a69fa449cca1db6a7ac609d7bd04107f685411aa1bebecdb3897ed0d6c00b46a56381e5968b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dad8952d2acaa7ebb6da732dd2e34cc2211a953d575e70137e69ce03526f0677ffc2c77f3488b19a3383188e0beaa03fd32b97e7a991fadd8d9d2c71a2d37c836adba04e6f9b5a9f58ecdfb3aaaada4161e283ecb8c295efdf53635ba73ca20f47181e9d7529da701fb654d55d99ff7a9af4c5b678f7ba7d764c48ea2b15569ee1d20a10029a50d5b1100356b64916c6c38526d1dac1f169e5f4250f27dd9cb7454af6591aac3e7353b3a083f310d735eb7a7530fcddc3d06fad7efbca9bf7e3e22306fa2dfd6a184cf5d0acc29ef7cc35c07a7c1e2fc75bb42c80834f000c5d85b293f40ed6b605ec94df44d87712eec2ad1d1386564e5fd2491ec42317aea9058a44e850b08e2a2c4d261c7c59a96be65d89555285c24326c052b5d102cb8a8341b97fcdb28bf8ad1a5591613dc119f7bc44abba455075baf954149a05ae35f13a1e585445577cd9f13c20a04194307716df5f290403147dc728cff8324ee06b0724bbd11fb59a4f3d717a15726c41113e1fd7adcacb5e303a974dd1f6b74028bd1c61f204a43a8ec0bdcf161ff8f2310ac411ceb866d641d29ca3e68fa259f6ee960d3d5835f930f788a3021c5467b619dbc9e5b8b80a6bdac820d1f56fa282fac56c299a7b2cd1d7b2d9b81e6c28bf2a7d6da6b40a02f4ba2aee0f37311c16b941aeaa11e6e40b16f91cad2089ccfc3")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x3f34a69e20ecb3a92106aaf5765a4d2f2925681b70965aa97ecd149e4dcca4c396b24f2969786544b8bc42b2f5c336c0b61fa38333c99414bc59b18c59d932c6b15e442e616d2967a22bd9a3397ee12621b1da977b95aa46c790eaa07ae23b1dbc9f783ae081d7757ef01daa2a24408c1262de6a12c321ec28373be4065f63ad65129cef62e7ab15ab49d89e507d6241c8f29a28fee463039e62ec7822e4d01537fee8357d3150b1184e777506b4baf634fd2e7d3c56a4cc35d422816a5ef910b6414e8b37639b6dc29939ddaddae87c7ccabb0b75619fc305ddcb15e4ca72c73013a4747deb10967489e1099b1528268b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadb848cccce62965ee2913c61fa41d0c5d26325b0d2e89fd6339a386bd1fc53664f2856c080fd1a3145f920c765616630d8bb964fe4d3cf1653f1e1190400181a76ff9f9476d6ae4052410c981bc8c81b5399d2c692b51e8278808751494a116ba9170ffe2c2c2506d06b890dd47cd00209933562c035a310647059f774c0a64571b7bee8319de78d63e7fe5e1775ce77916de84c6ab8b383cb036c1b7e3ac6b12f47f87c3c016ab16f20a43a94d1f1ea3c3fa3e2029058a58e852959e2c44e25ef79865f4a3fa4d4872d79324272202aa306f233fc235d364a0dc9009b21e49295f78e38a820279050ae921df1c039eb70ee202e2b56445d158c76fbb4d70a70830f3a13e605816ad032d5532d56ea552d6b30381ccfd1ebdcb5a80472c86170640b4e6cbaccc36f194c8183fb061b539bca57425350f63374e72d6058190b571945593877f3a6e89e25501749b658bca067f220c7d68b4e4a4b6b0b113d6e734bccab561190509484a71f3157e482edbf99693852303c5a3106e0105292e94470c9a819ecd6e6266c304bcdf5fc9743da87955290d5ddfdf9c708658e236a817774fa302c8a328f308be03a36491f609c7e5e13a0a18b3ea16714ccf0479352394350a6637ac47d06c213a0dc7b44734b57235d1eadda857b1ee2504c67a12f69c034c72498dd2e14e6f06679ef2109c")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(hexToBytes("0x085d8b17dd23a3d2e6b785f5a3ca389c5c6b6b0958fa6aa24daed4dcb0d0ac218ca53d13adcb507df05116e054c5bab3969c377f4c27145cb877eca54af4a7a44454c09d327fd0a87c9c100d6d2807566c19d0b9f4b5c620ea3f184c04f129db0d3862d12ac56a68961882ef6acade3960470814fd165d1d99ffd0312a114f382f7dc2b9698a741c2d385738b9710acb83bbf397c8725f03e0e4ed823b10d90a8b9b1bd5592120c58f6f607ec735510dddf689b75f0757a36243875ae89d8500a3615ab86d8b9294c1f39754f1e13307e4871dd4711c89b88ce19e4f641344faa00a8c02d5caabebd4a0491ce7ff99e38b7520b215677afa1394464057709837dfb22b04b53c69011da7926c341cf6e77a2ed27912c40267c826cca53f876dadaca589a2245daa460c8b1d2692e3b8dd2b16b33d435ea751f62a57454472218e0a5038326422481f02a2113d9f8ac15691f1f2872315a81a64c84a6876ea55b3ce693622fa8c9ba8f69fc5efc27e83f11c5d43f6e72c1c9587c1a2dd1e1306194655872e7c923adb6b087ee020275deccf047dc74d45929461b28d4768b89445469de53ee0e493700b981d62115bbb9439d9070e4a0fe2faa37f3b96fee5ec6fa8e7004fbed855ed5d5f89f195a3c8facb03d00f53eed56acd853cd824d18b33347a2dff9fe2ceccbda9f89da0453a16fa9febd9c0e41c4419258d3ee7860b58398398f28dcf558de5c8b9ded668f694747764bf42b028d45b2de49aa23818273e7312abc3dd24f5281315cb5662bf479ae50b4a61c100fdcf796f0c1aa06854706ed7f123dc669e2f6fe1d15c2b35889e9e93894fc20d8168c80d6eded2ce0092f3ceb63faedb3ac2fb3d9105f4fa39e9ba3b0fd8e212d970b648c608d7fbb85aeca7f64be454b20db0eebb41271eba6f6250796e1a373f2728c37a690a5869219dc312969a1dd9a643e7186f7e964eb814bd528eb1480303bccd3489bf616d336de95722b7f5f8fd0eac5f01d064bf8ffdc5d88127dd46f23d65016545ed2ea21e5efd32151c5fb4779851c0e50445b85a9ca74d1b249bb0a6ab3c3b7c7f73eceb262ed642fa9750c2819cb9c58a49")),
				},
			},
			preGammaA: types.TicketsAccumulator{
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x09a696b142112c0af1cd2b5f91726f2c050112078e3ef733198c5f43daa20d2b")),
				},
				{
					Attempt: 2,
					Id:      types.TicketId(hexToBytes("0x13fecb426e0a73b84b58b9a0832b11582dc971e79c5399e69f0baf1a244c7787")),
				},
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x3a5d10abc80dda33fe3f40b3bb2e3eefd3e97dda3d617a860c9d94eb70b832ad")),
				},
			},
			postGammaA: types.TicketsAccumulator{
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x09a696b142112c0af1cd2b5f91726f2c050112078e3ef733198c5f43daa20d2b")),
				},
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x0b07226e17e82a9e447dd914d3a072fff7015c9f58681f7f5f4213487259891f")),
				},
				{
					Attempt: 2,
					Id:      types.TicketId(hexToBytes("0x13fecb426e0a73b84b58b9a0832b11582dc971e79c5399e69f0baf1a244c7787")),
				},
				{
					Attempt: 0,
					Id:      types.TicketId(hexToBytes("0x1ec38833e785b52adca8c791f8bf479c8cae805c93ce1ed245b32b273e3c9322")),
				},
				{
					Attempt: 1,
					Id:      types.TicketId(hexToBytes("0x3a5d10abc80dda33fe3f40b3bb2e3eefd3e97dda3d617a860c9d94eb70b832ad")),
				},
				{
					Attempt: 2,
					Id:      types.TicketId(hexToBytes("0x8d803b93b5820db802c0b1efbb97de8f9b0ee9a6b4f0e5d63fbab4be47f17a9e")),
				},
			},
			expectedErr: nil,
		},
	}

	for _, tc := range testCases {
		s := store.GetInstance()

		gamma_k := types.ValidatorsData{}
		for _, pk := range tc.pks {
			gamma_k = append(gamma_k, types.Validator{Bandersnatch: pk})
		}

		eta := types.EntropyBuffer{}
		eta[2] = tc.entropy

		s.GetPosteriorStates().SetGammaK(gamma_k)
		s.GetPosteriorStates().SetEta(eta)
		s.GetPosteriorStates().SetTau(tc.slot)
		s.GetPriorStates().SetGammaA(tc.preGammaA)

		err := CreateNewTicketAccumulator(tc.tickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}

		// for each posterior gamma a check if it is equal to the expected one
		for i, postGammaA := range s.GetPosteriorStates().GetGammaA() {
			if !reflect.DeepEqual(postGammaA, tc.postGammaA[i]) {
				postGammaAId := hex.EncodeToString(postGammaA.Id[:])
				postGammaAAttempt := postGammaA.Attempt
				expectedPostGammaAId := hex.EncodeToString(tc.postGammaA[i].Id[:])
				expectedPostGammaAAttempt := tc.postGammaA[i].Attempt
				t.Errorf("expected %v, got %v", expectedPostGammaAId, postGammaAId)
				t.Errorf("expected %v, got %v", expectedPostGammaAAttempt, postGammaAAttempt)
			}
		}
	}
}
