package safrole

import (
	"testing"

	"github.com/New-JAMneration/JAM-Protocol/internal/blockchain"
	"github.com/New-JAMneration/JAM-Protocol/internal/types"
	SaforleErrorCode "github.com/New-JAMneration/JAM-Protocol/internal/types/error_codes/safrole"
)

// publish-tickets-no-mark-1.json
// Submit an extrinsic with a bad ticket attempt number.
func TestCheckTicketsAttempt(t *testing.T) {
	ticketAttemptErr := SaforleErrorCode.BadTicketAttempt
	testCases := []struct {
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		// publish-tickets-no-mark-2.json
		// Submit good tickets extrinsic from some authorities.
		{
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0xb342bf8f6fa69c745daad2e99c92929b1da2b840f67e5e8015ac22dd1076343eec00b574369c92536db6d65e5d6a3bc01fc8612cccbece4a32a8439e5ce646491be3b7b13eab6be3190eb57ddbde2a4c20472768563b12aa1e1b8b299cd41b8d2b566c14a7f8643a5d976ced0a18d12e32c660d59c66c271332138269cb0fe9c6707eb7821301ae4c172a9648036cf719fa2f64f272a008dd58f0734c00a440f7f5a457abb3c9271ffe61f8dc998ddda0499a783836b54e5b727f44a2eecb017b0341a1868fc476a0d6da019b5f2b4e521903b00e937f23b17ea49d6928c615841da5442e5b070079af6cdbbaed964a9b044dcf1ae69ce2e2febec37f6369910a0b20b9dce71b4cd3396e44a90a0a4c404cb170d7ffd2c5467f152bd5daf40b3b81e067e10509356f4b6e98a990c37346348d20fd47aab334c3acf2b51d58e63e0e5eecf84f646b0df292ee25b2d7267831b1ae29540a0604bc50f213f7c981752b740d026f8c4734de9c721f0fee4254053f763776a97e9b870d11e1a9c58b27db5b035b91c7276a18ed3654fb70b52a38b80503ba0cc88c53a04793bea963efdc3ae0e98fd0cda9330796ae9ca3d9795f4abe806978fab744e8c5659fb7469a5beb5bed213fdc1b036763c7f0d911627d43aa01340570c946e13d0951aa64d452fc7f7e842389fe25bd646d674931263656585c2f13336ff64a90674b0ae1df8b8a9f0fe28c8a049eaec1c788fde0d883958f9c08820751b9f9143bca8d656a12d28132eb81ebde2d21680cd0a6f589f9c8ebd2fe84917aa16492d91cf7f58aa92d1bb9b9905a88f8a9846637d77439641c33c9db9fe855ce5b532cbe00c6a828ee974f5918f970e106f2f60bc9cecebcf0a35a239934cbbb29f0ec99a412b247b54c96ac582b52179a8fae3a0f8956cfb6fc541902bef749a034a9a59cb08715fbed847592784097b2d20b923a14bb2f8319508341bf39b16b104199477680af2a7b2a2dcddba88963b64229e1a25ce8cb9f7fbdee49c6ecfb31751c7a237b46578030c7f0c5088d4b54ede07c1ecdc3730a07ff78ccd8c0a020cf494f5059f21802cb8f866a680854ce7162bfa8a")),
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0x8e6eb88b02110c941451eef7da84e65bafaefcec1b1a5640ad579425e4a7e3ee5b4c2e5450ec6f28e6d3df3e5053be8d62ec3e747a07cc3a6d79261f27b5273009683feb1d245654ae63def9b9acf58319d5b29ee06f8320384e5159d5518301a8b4b304c09306a65e8720633d53bfa3f663bb2c0c53fbb12131828de1c53ce3d7f4f246bbee1ff781dfcc2dc72648df86ce95c26eef9e741c36462524f87b05ea21c2282ee16fc0e5ecab17e44e4da2c798c7b3ae0e5c6900a3cf6b34d4e908948c0ac0e7c8105139b896fd31b08747cbd53175bce1bf2e6802ee47c2e71a3615e16a6d12c0066c7b9d99db4daaa3fa8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fab655b1734cf497f9f1eee88206725753f458ec179b7fe13fd716398c99fe8625c0b5d927bbe57ec27c0cd3d13b0814e96320a0a6544cd8acda84652b36e890bf1f7a9e58bd6b38594927fa9a0e0dcaf28536367bb23b02e3cf6e956fef877167429029330ea32a91625a696a0dfe07595b94604217e81f4c09965eb37d7893efa301dcb080287f030d21eb8d1d1a4809f862b4ff27f55d39d250acb16e77a57ba22eabab8a6aaacda645b0ba77e0a8122bfb7460e19d2380744a0ad229d2302330aebd3ba74cccef6491ed008b091c87865794dc53f72a7d2c510f38140365619da062dcd29d690458a09f48376a93518939af0769a8c9f6c16b1712e7212313d80993eaca25e4be20d54407613ea2002eb52b945d9d4763eea2f7bf0c2ae3e48ee17e9c5cd084bc4445ac5b30dc788f7a542390a25ccab38f18c47c242e9348053ca1f34fc6e242250cc129574e368849945718f368a663f446b37a7780d31b27cb2cc16d0dd29e9c862c3696df5ae1b5de7500bdb4ec8f3eecac51a1c08f6c5a34855e9daa172c7335f539d463135b0efc1e7ad27afe2eea3f2f938e38300fde5013abfa966d6cabc211147edcfbd53989e552fa5c25b9c4fd4cb94fa4ff08c6fba11fbfe25eef500d3e43152bebcfb813ba33e285702a00a843f920b807c199a47e6b231440a02edf8fd793af8db")),
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-1.json
		// Submit an extrinsic with a bad ticket attempt number.
		{
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0x9ddee7bb67268130bbb23889b327e662cbe832884e203148ba9b1e15539702d15b25ec30bb1c8857402a837ffcee3d01495a3140028473ab4cdb1fa2fed9f71f22309a4d59d411d8fbeb9dd5ab06d981dad3ad0e7859792d79dbdc7e055aabab891567467d39221b6110f5cb2ba389dba903af3fde624596f845202fcc4c96e6902d347383f957fe0a9bf6cf5399a43fd70bea1234072521d1e64acbce8de10affd6dc96ab1673ebd6e36e205eb4d0af54206583778499ddf25c59a25a1882008c521baa47ff355a99a28380d06f16b4aa3b51aac66b8a6d7bc4454b8d0f676d837caf35f2ab3c4b9ec8cd0e8fadd16e8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f8b37ab6773b166899f965d6b2ffca0f85017a295d680359230823b3c3d91e9e7167ef4a579990035e4ad5e257dc1597ca01b77cba029dea7e18449fc9a31e684cb462dcc3612c169ae2a295993efb8b0a9196825f9bc3be736ba8be970e3b3c3c257ab5d8686066ecd2ee5e51f8095b655c1f8415bd6589c1f20528af4a8402323f7f76fbe5a72955ecb08a97dd7e93913fad39ebf7fddf65d8e5f1f4327a516dca6856b0a741645d4102188cd16c136ce3bb59075174174091e3b2d525aec5c7bcafa2e11017216b8c86108c38038ea0066690a36e6363470809ca38c594b61413a2d8b7b1a141587f608fb03fbdced6999bcbb11074dcdc34ea6b42028a671c786b7e2e36f12e143f4cc1282c0ea47a013c62d084a2f9322e20f6fb49c2449682d5fde30e895bc2a3f09afe5fd79879748624a37a79de0be419dbc8073e750845210897c364af4f007ee877e1f1214d18aa7d0b688e87cfe42adfbc6600bbcdd08001252b0bac47a3127098b4701313ed65ec54dd6158abdc23d4c92ec20c91b78b458bcd5d2f0e352bb0bb315ae47a8ce5a879dbd249ec5f35e9b8cacde14eac8c6383463b0ca7637306d547894b29fada8d0b7bb3b8dcbd1457ce5092059b9b3a8c0dca0d5db44f01f937292cede604c5526bdbe780e5029fb90ee2a7e7b2a903a8ce7d7be8d7139ba448f683d1c")),
				},
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0x38eff9f9cac7ca015bafd5c84e84ed75ee86b6ecc98902044a7a7aa28d60f0e547f9c1bf782f01bc5fe47d19858abe928ad3eed82e0f77680e91ed8a1603c6a11028f8df1478991aa1a24cb243603d3f434a3d563d7ec08931c6f2bfa38f9ebf99527196430c2f6bc38cc775336bffb82ecea3e8040f80a846b638a4a1a7388d629bbd5c127a56b0a1b5d6b1d7fefcef0c39218c084a6921141376ed64f72b0869c6301b8fd3a0721774ae1353cbb31228f04f5491aa72387550d12f813d15188f55a0c9095bc21a9a084bf10b434b2fbfc2f1879f2235342bcc03ce4dbe0c2902c6c5dfa4b309da00a8b72eb3be15d28d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7f819e2ee13f4951a970075b928f4f53614c2038cb899083c5b0ffe5fbe5685a8ce738129c83791d0331b7bdf75dbde863addc1440fc771664e6ced8803cbb074c377c8203e453035d4061a7ccf651f7aa70782322cf5a9ade316f62b2c109f22156b466c349402da1333b8c144aa503c1aaedd49097055e780fc849b3ba68365a710e12206af8802ead9536aab3535be932bd78360283c6aa70a457146921021b05656dc7ca225f390fb80740a08ff15c340dfddbd4521088b0d2c253a6fa9014529489123c923fed4d2d0dbe9035192d51a1248dba1420cd6149d71215add23092d1eb598dbd38be337d6f11255a9905d60113a0a8cff319834396f46dcb802b84c64915bf2a5f65546188d8b17824a9f7ef77ec2aa173112135dc6c4b0ae81b238470f7b19c8e47e9e34d4003b257735936b257984e182bc6e4af1240e5505f927c65e506314c345cac1e5001af7e41436fb1836ec06c0cd1c8bb90041aadbd265a074f58f047e371e31625ed919eb78e0dc40f7970b17ee399c66cb9b3c58dce8cb9e3488c1571d3489bba82262d15947524a1e3aadb625067ccbdb8f63e5b52dbe5e579e37a13b39df9655e0b2045de14ece78958e4843b912ef3debd8462ab6b13c10588bde65f9af8ceaf575b45797fe80dae6d7e79b1ed37c891b709be039ea1e12761b85475abd453b032e720")),
				},
				{
					Attempt:   3,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0xfe088f1bb3f1d2bd9412f40675eb3f916feb60d772649447a8efa0b83e205c691f1369ac6785852d5469fd673a111a6d4f8d28c2b23f57b7c6040b050f0ac2b7bece0cf45d498dea58451a0c53625fccb4d55408f02f38a338b4eea5664572dec26081caa9f2643d3e10be045cb44e2f0d0505d50c580e58a651376eb32e89d2a5ca12ecc722b330cbfc039c3c97d202b9b1ef853f3095c02cb697148d33ef18245b842880ae824623450d8179affe49ead9992bb259ac1e9cbb846e41035d1890d3440407102824f9e4d56b10263ab9deb327506cd2daef0f928b41067d0119f643224d352939ba7e37891c71a231ac8d6db123d2815dbfa6cbe74866ed9855eecbbab8e2011f84f71a2e360caeac3bcd64c4b46b11ca167e238cf5f0ccfe7fb46ac862727e5d2255aa1c6682b57a9e47d15e1b3eab721e05d16822cf0c234623eac35a8e1f092419a10320e5115c77a6ae5e2a2affa64f3fe2768a02e3738c73589193d1bf7d60d13aae555e265e62923a460a0f5c354252acf32024763f798ffa2f16b84c9a83a1f6d753c9aeda0a4d501c1c3280075c307a1bf92a5cfd0d076cf20d04930d9fe2527f94643736034da5a76eee730c6c637f0533f69fd872e8f27c4d192a563b493fd557b99a131eaf4e032780389786b5967df8c380681185040a25fd4501a34778fd770c36ae17c8350a4f6ec2f0aa9a787f7e7ea94311455ab012b6b80327fe08777233dd2bc5f14f74ac364d12e1e5ed9164f1dec952fbea646c0d122962eea7c266babcd568e4d72796f414176fddc70bd12ce6ad301f42727cf1433dfcfedd6e37f23262cd4ecb5652fe52f2eaf712ff07f63b7a5e8b8374d2791b16a0086fbb21b8eff72d78cf1b399c3cceed5da34274b17856916c6162af17cb6b7d696573f9359bce26972ff6251437685da89996cd1060aebc83ad096b6f5afbb0313c7bffe3b3a315afde15db3afa0791622e6d8d5f3039393bfb31333a2c8ebb926e4b7c4612a943bb002ddaffbc29593ad650568642ca46ae35205f576315b6d49ae87179176549527c788d587f54c0d0dc216a3e4747a7230a55de871fa9c5ea489caebb157ec7")),
				},
			},
			expectedErr: &ticketAttemptErr,
		},
	}

	for _, tc := range testCases {
		err := VerifyTicketsAttempt(tc.tickets)

		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}

// publish-tickets-no-mark-7.json
// Submit tickets when epoch's lottery is over.
func TestVerifyEpochTail(t *testing.T) {
	unexpectedTicketErr := SaforleErrorCode.UnexpectedTicket
	testCases := []struct {
		slot        types.TimeSlot
		tickets     types.TicketsExtrinsic
		expectedErr *types.ErrorCode
	}{
		{
			slot:        types.TimeSlot(0),
			tickets:     types.TicketsExtrinsic{},
			expectedErr: nil,
		},
		{
			slot: types.TimeSlot(types.SlotSubmissionEnd - 1),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature{1},
				},
				{
					Attempt:   2,
					Signature: types.BandersnatchRingVrfSignature{2},
				},
				{
					Attempt:   1,
					Signature: types.BandersnatchRingVrfSignature{3},
				},
			},
			expectedErr: nil,
		},
		// publish-tickets-no-mark-7.json
		// Submit tickets when epoch's lottery is over.
		{
			slot: types.TimeSlot(types.SlotSubmissionEnd),
			tickets: types.TicketsExtrinsic{
				{
					Attempt:   0,
					Signature: types.BandersnatchRingVrfSignature(Hex2Bytes("0x252f6071a3191c2381f6c332334372b8065d79183a02e6e95ff240ea006453ca36ba99dfb55f50e7955be524b562b0a8413f7abe2b5b9b3a44d0d1123e3036b38290876da04260d1bf2d9c0077b843b8f9ce7c4cebe0cf431f15266b56dfcff3a5ad6ed6245148298eadc4ad4776cc2f3467324c7560884ceb211aecdbdf6bea318a14a119ee1eebe8afb3534925658b45fe3f8aa1407ff0206603046565990f8c859c42ecfc88fbaeadac2ae76eae37b6f47b65dfa616dc68dbf140df31010ab7637ba2b5ef5cda3b6b081fe13b8f07de3d6d44a1d93573c33f646467f63b0f5e30e542ebd1e8981f15a4abdb7b3caf9107bd20fe94a01157764aab5f300d7e2fcba2178cb80851890a656d89550d0bebf60cca8c23575011d2f37cdc06dcdd81812aca59cefbcd6608027bf31cfbd977198ca41a994cf923293a77e7053bb29d533fce58a043bdd23fc8b3be69ff368e448b79dbd7e03490e5badeca805d83792b958fec27fe34eea99864a92c6bce9ff66c68acdca02b9d6d82c9476e4dcd6ca1c61ab04dce7b819fede57dbec2e3073bd4c3b4da72cde4d6c09ab449503ae505561b412783d3418d51ce5be337309e33969949cb226230741cc8288a665db5514a7260c93e102cb63999fc413f5bd4edc8ea2331f683afbd04c9484f590b6cc01be784c8924f91157231fd684c79913ba34a1f1ce1467b22ebb9886ac66399b857ea2ad147fa056250904963055fc70f5d35712b8ac18b28b016512def21a1ef1aa4f4166087f1adb60fd7ee52985ddda044ee0641b8ddb47ce0fde5270f573899853d6279c2acc0f4fd8fffb14ff2ad82e3a83e913f8fcce1569ce36d3f8817e82170063612021b0f46ccf2ae8d3c75e7bfbbfd145adae5dcb448fcd7e14687850c7f7622e9265f86cf4b036cf5d945df30c6ddd62b6d4288f3d1ccd7b85e75ff89a3be7973fb22647d19f30e478e8d11b0ab7e357e5fb3d16b0e2065bf5c5d506e30afc386c3ed18c6189ed7cd530a97cf1550208a17ba774869d58f18af78103a4bd9eb6629164f77eb13fa08cc1cdf96bf963f663e378ccf97bae57538fde7da504a9c39c2530aab552f441c")),
				},
			},
			expectedErr: &unexpectedTicketErr,
		},
	}

	for _, tc := range testCases {
		// Set posterior state tau
		s := blockchain.GetInstance()
		s.GetPosteriorStates().SetTau(tc.slot)

		err := VerifyEpochTail(tc.tickets)
		if tc.expectedErr == nil {
			if err != nil {
				t.Errorf("expected nil, got %v", err)
			}
		} else {
			if err == nil || *err != *tc.expectedErr {
				t.Errorf("expected %v, got %v", *tc.expectedErr, err)
			}
		}
	}
}
