package extrinsic

import (
	"testing"

	jamTypes "github.com/New-JAMneration/JAM-Protocol/internal/jam_types"
)

func TestAvailAssuranceController(t *testing.T) {
	AvailAssurances := NewAvailAssuranceController()

	if len(AvailAssurances.AvailAssurances) != 0 {
		t.Errorf("Expected %d assurances, got %d", 0, len(AvailAssurances.AvailAssurances))
	}
}

func TestAddAssurance(t *testing.T) { // include test for CheckAssuranceExist
	AvailAssurances := NewAvailAssuranceController()
	AvailAssurances.Add(jamTypes.AvailAssurance{
		Anchor:         jamTypes.OpaqueHash{0x0c, 0xff, 0xbf, 0x67, 0xaa, 0xe5, 0x0a, 0xee, 0xd3, 0xc6, 0xf8, 0xf0, 0xd9, 0xbf, 0x7d, 0x85, 0x4f, 0xfd, 0x87, 0xce, 0xf8, 0x35, 0x8c, 0xbb, 0xaa, 0x58, 0x7a, 0x9e, 0x3b, 0xd1, 0xa7, 0x76},
		Bitfield:       []byte("0x01"),
		ValidatorIndex: 0,
		Signature:      jamTypes.Ed25519Signature{0x2d, 0x8e, 0xc7, 0xb2, 0x35, 0xbe, 0x3b, 0x3c, 0xbe, 0x9b, 0xe3, 0xd5, 0xff, 0x36, 0xf0, 0x82, 0x94, 0x21, 0x02, 0xd6, 0x4a, 0x0d, 0xc5, 0x95, 0x37, 0x09, 0xa9, 0x5c, 0xca, 0x55, 0xb5, 0x8b, 0x1a, 0xf2, 0x97, 0xf5, 0x34, 0xd4, 0x64, 0x26, 0x4b, 0xe7, 0x74, 0x77, 0xb5, 0x47, 0xf3, 0xc5, 0x96, 0xb9, 0x47, 0xed, 0xbc, 0xa3, 0x3f, 0x66, 0x31, 0xf1, 0xaa, 0x18, 0x8d, 0x25, 0xa3, 0x8b},
	})
	AvailAssurances.Add(jamTypes.AvailAssurance{
		Anchor:         jamTypes.OpaqueHash{0x23, 0x98, 0xce, 0x69, 0xc3, 0x58, 0x5e, 0x1b, 0x1b, 0x57, 0x4a, 0x5a, 0x71, 0x85, 0xa2, 0xa0, 0x86, 0x35, 0x0a, 0xbd, 0x46, 0x06, 0xd1, 0x5a, 0xac, 0xe8, 0xb4, 0x61, 0x0b, 0x49, 0x47, 0x72},
		Bitfield:       []byte("0x01"),
		ValidatorIndex: 1,
		Signature:      jamTypes.Ed25519Signature{0xdd, 0xa7, 0xa5, 0x77, 0xf1, 0x50, 0xee, 0x83, 0xaf, 0xed, 0xc9, 0xd3, 0xb5, 0x0a, 0x4f, 0x00, 0xfc, 0xf2, 0x12, 0x48, 0xe6, 0xf7, 0x30, 0x97, 0xab, 0xcc, 0x4b, 0xb6, 0x34, 0xf8, 0x54, 0xae, 0xdc, 0x53, 0x76, 0x98, 0x38, 0xd2, 0x94, 0xb0, 0x9c, 0x01, 0x84, 0xfb, 0x0e, 0x66, 0xf0, 0x9b, 0xae, 0x8c, 0xc2, 0x43, 0xf8, 0x42, 0xa6, 0xcc, 0x40, 0x14, 0x88, 0x59, 0x1e, 0x9f, 0xfd, 0xb1},
	})

	// Duplicate assurance, validator index 1 with index 0's data, test for CheckAssuranceExist
	AvailAssurances.Add(jamTypes.AvailAssurance{
		Anchor:         jamTypes.OpaqueHash{0x0c, 0xff, 0xbf, 0x67, 0xaa, 0xe5, 0x0a, 0xee, 0xd3, 0xc6, 0xf8, 0xf0, 0xd9, 0xbf, 0x7d, 0x85, 0x4f, 0xfd, 0x87, 0xce, 0xf8, 0x35, 0x8c, 0xbb, 0xaa, 0x58, 0x7a, 0x9e, 0x3b, 0xd1, 0xa7, 0x76},
		Bitfield:       []byte("0x01"),
		ValidatorIndex: 1,
		Signature:      jamTypes.Ed25519Signature{0x2d, 0x8e, 0xc7, 0xb2, 0x35, 0xbe, 0x3b, 0x3c, 0xbe, 0x9b, 0xe3, 0xd5, 0xff, 0x36, 0xf0, 0x82, 0x94, 0x21, 0x02, 0xd6, 0x4a, 0x0d, 0xc5, 0x95, 0x37, 0x09, 0xa9, 0x5c, 0xca, 0x55, 0xb5, 0x8b, 0x1a, 0xf2, 0x97, 0xf5, 0x34, 0xd4, 0x64, 0x26, 0x4b, 0xe7, 0x74, 0x77, 0xb5, 0x47, 0xf3, 0xc5, 0x96, 0xb9, 0x47, 0xed, 0xbc, 0xa3, 0x3f, 0x66, 0x31, 0xf1, 0xaa, 0x18, 0x8d, 0x25, 0xa3, 0x8b},
	})

	Expected := []jamTypes.AvailAssurance{
		{
			Anchor:         jamTypes.OpaqueHash{0x0c, 0xff, 0xbf, 0x67, 0xaa, 0xe5, 0x0a, 0xee, 0xd3, 0xc6, 0xf8, 0xf0, 0xd9, 0xbf, 0x7d, 0x85, 0x4f, 0xfd, 0x87, 0xce, 0xf8, 0x35, 0x8c, 0xbb, 0xaa, 0x58, 0x7a, 0x9e, 0x3b, 0xd1, 0xa7, 0x76},
			Bitfield:       []byte("0x01"),
			ValidatorIndex: 0,
			Signature:      jamTypes.Ed25519Signature{0x2d, 0x8e, 0xc7, 0xb2, 0x35, 0xbe, 0x3b, 0x3c, 0xbe, 0x9b, 0xe3, 0xd5, 0xff, 0x36, 0xf0, 0x82, 0x94, 0x21, 0x02, 0xd6, 0x4a, 0x0d, 0xc5, 0x95, 0x37, 0x09, 0xa9, 0x5c, 0xca, 0x55, 0xb5, 0x8b, 0x1a, 0xf2, 0x97, 0xf5, 0x34, 0xd4, 0x64, 0x26, 0x4b, 0xe7, 0x74, 0x77, 0xb5, 0x47, 0xf3, 0xc5, 0x96, 0xb9, 0x47, 0xed, 0xbc, 0xa3, 0x3f, 0x66, 0x31, 0xf1, 0xaa, 0x18, 0x8d, 0x25, 0xa3, 0x8b},
		},
		{
			Anchor:         jamTypes.OpaqueHash{0x23, 0x98, 0xce, 0x69, 0xc3, 0x58, 0x5e, 0x1b, 0x1b, 0x57, 0x4a, 0x5a, 0x71, 0x85, 0xa2, 0xa0, 0x86, 0x35, 0x0a, 0xbd, 0x46, 0x06, 0xd1, 0x5a, 0xac, 0xe8, 0xb4, 0x61, 0x0b, 0x49, 0x47, 0x72},
			Bitfield:       []byte("0x01"),
			ValidatorIndex: 1,
			Signature:      jamTypes.Ed25519Signature{0xdd, 0xa7, 0xa5, 0x77, 0xf1, 0x50, 0xee, 0x83, 0xaf, 0xed, 0xc9, 0xd3, 0xb5, 0x0a, 0x4f, 0x00, 0xfc, 0xf2, 0x12, 0x48, 0xe6, 0xf7, 0x30, 0x97, 0xab, 0xcc, 0x4b, 0xb6, 0x34, 0xf8, 0x54, 0xae, 0xdc, 0x53, 0x76, 0x98, 0x38, 0xd2, 0x94, 0xb0, 0x9c, 0x01, 0x84, 0xfb, 0x0e, 0x66, 0xf0, 0x9b, 0xae, 0x8c, 0xc2, 0x43, 0xf8, 0x42, 0xa6, 0xcc, 0x40, 0x14, 0x88, 0x59, 0x1e, 0x9f, 0xfd, 0xb1},
		},
	}

	if len(AvailAssurances.AvailAssurances) != len(Expected) {
		t.Errorf("Expected %d assurances, got %d", len(Expected), len(AvailAssurances.AvailAssurances))
	} else {
		for i := 0; i < len(AvailAssurances.AvailAssurances); i++ {
			if AvailAssurances.AvailAssurances[i].ValidatorIndex != Expected[i].ValidatorIndex {
				t.Errorf("Expected assurance %d to have validator index %d, got %d", i, Expected[i].ValidatorIndex, AvailAssurances.AvailAssurances[i].ValidatorIndex)
			}
		}
	}
}

func TestSortAssurances(t *testing.T) {
	AvailAssurances := NewAvailAssuranceController()
	AvailAssurances.AvailAssurances = []jamTypes.AvailAssurance{
		{ValidatorIndex: 1},
		{ValidatorIndex: 10},
		{ValidatorIndex: 6},
		{ValidatorIndex: 0},
	}

	AvailAssurances.SortAssurances()
	Expected := []jamTypes.AvailAssurance{
		{ValidatorIndex: 0},
		{ValidatorIndex: 1},
		{ValidatorIndex: 6},
		{ValidatorIndex: 10},
	}

	if len(AvailAssurances.AvailAssurances) != len(Expected) {
		t.Errorf("Expected %d assurances, got %d", len(Expected), len(AvailAssurances.AvailAssurances))
	} else {
		for i := 0; i < len(AvailAssurances.AvailAssurances); i++ {
			if AvailAssurances.AvailAssurances[i].ValidatorIndex != Expected[i].ValidatorIndex {
				t.Errorf("Expected assurance %d to have validator index %d, got %d", i, Expected[i].ValidatorIndex, AvailAssurances.AvailAssurances[i].ValidatorIndex)
			}
		}
	}
}
